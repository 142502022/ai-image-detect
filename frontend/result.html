<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Analysis Result</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    background-color: #f8f9fa;
    color: #333;
    padding: 2rem;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  h2, h3 {
    font-weight: 700;
    color: #222;
  }
  h2 {
    font-size: 1.8rem;
    margin-bottom: 2rem;
  }
  h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #eee;
  }

  /* Grid Layouts */
  .image-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .analysis-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
  }

  /* Widget Styling */
  .widget {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }
  .image-box {
    min-height: 300px;
  }
  .image-box img {
    width: 100%;
    height: auto;
    border-radius: 8px;
  }

  /* Specific Widget Content */
  #objectsList {
    list-style: none;
    padding: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  #objectsList li {
    background: #f8f9fa;
    border: 1px solid #eee;
    border-radius: 6px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
  }
  /* Simple icon placeholder */
  #objectsList li::before {
    content: 'üëÅÔ∏è';
    font-size: 1.2rem;
  }

  #aiProb {
    font-size: 1.1rem;
    line-height: 1.7;
    font-weight: 500;
  }
  #summaryText {
    font-size: 0.95rem;
    line-height: 1.6;
    color: #555;
  }
  
  /* Button Styling */
  .btn {
    background: #5b3fff;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: background 0.3s;
    text-decoration: none;
    display: inline-block;
  }
  .btn:hover {
    background: #4a2dd8;
  }
  .btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .btn-secondary {
    background: #f0f0f0;
    color: #555;
    border: 1px solid #ddd;
  }
  .btn-secondary:hover {
    background: #e5e5e5;
  }

  .loading {
    display: none;
    margin: 1rem 0 0.5rem;
    color: #666;
    font-size: 0.9rem;
  }
  
  .error-box {
    background: #fee;
    padding: 1rem;
    border-radius: 5px;
    border: 1px solid #fcc;
    margin-top: 1rem;
  }
  .error-box p {
    color: red;
    font-weight: bold;
  }
  .error-box pre {
    color: #600;
    font-size: 12px;
    overflow-x: auto;
    margin-top: 0.5rem;
  }
  
  .footer-nav {
    margin-top: 2rem;
    text-align: center;
  }
  
  /* Responsive Design */
  @media (max-width: 900px) {
    .analysis-grid {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 600px) {
    .image-grid {
      grid-template-columns: 1fr;
    }
    #objectsList {
      grid-template-columns: 1fr;
    }
    body {
      padding: 1rem;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h2>Image Analysis Result</h2>

  <div class="image-grid">
    <div class="widget image-box">
      <h3>Uploaded Image</h3>
      <img id="imagePreview" src="" alt="Uploaded Image">
    </div>
    <div class="widget image-box">
      <h3>Grad-CAM Visualization</h3>
      <div id="gradcamResult">
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
          Click the button to generate a heatmap showing what the AI model focused on.
        </p>
      </div>
      <button id="gradcamBtn" class="btn btn-secondary" onclick="generateGradCAM()">Show Grad-CAM</button>
      <div class="loading" id="loadingMsg">‚è≥ Generating Grad-CAM...</div>
    </div>
  </div>

  <div class="analysis-grid">
    <div class="analysis-column-left">
      <div class="widget">
        <h3>AI Detection Summary</h3>
        <p id="aiProb">Loading AI detection results...</p>
      </div>
      <div class="widget">
        <h3>Analysis Outcome Summary</h3>
        <p id="summaryText">Loading summary...</p>
      </div>
    </div>
    
    <div class="analysis-column-right">
      <div class="widget">
        <h3>Detected Objects</h3>
        <ul id="objectsList">
          </ul>
      </div>
    </div>
  </div>

  <div class="footer-nav">
    <a href="index.html" class="btn">Analyze Another Image</a>
  </div>
</div>

<script>
// ‚úÖ Single data parsing and display logic
let data = null;

// Safely get and parse JSON data from localStorage
try {
  const stored = localStorage.getItem("imageResult");
  if (stored && stored.trim() !== "") {
    data = JSON.parse(stored);
  } else {
    console.warn("‚ö†Ô∏è No data found in localStorage for 'imageResult'");
  }
} catch (err) {
  console.error("‚ùå JSON parse error:", err);
  data = null;
}

if (!data) {
  document.body.innerHTML = `
    <div class='widget' style='max-width: 600px; margin: 2rem auto; text-align: center;'>
      <p style="color:red; font-weight: bold; font-size: 1.2rem;">‚ö†Ô∏è No analysis data found.</p>
      <p style="color: #666; margin: 1rem 0;">Please upload an image first.</p>
      <a href="index.html" class="btn" style="margin-top: 1rem;">‚Üê Go Back</a>
    </div>
  `;
} else {
  // ‚úÖ Show image preview
  document.getElementById("imagePreview").src = `/uploads/${data.filename}`;
  
  // ‚úÖ Show detected objects
  const objectsList = document.getElementById("objectsList");
  if (data.objects && data.objects.length > 0) {
    data.objects.forEach(obj => {
      const li = document.createElement("li");
      li.innerText = obj;
      objectsList.appendChild(li);
    });
  } else {
    objectsList.innerHTML = "<li>No objects detected</li>";
  }
  
  // ‚úÖ Show summary
  document.getElementById("summaryText").innerText = data.summary || "No summary available";
  
  // ‚úÖ Show AI probability
  const aiProb = data.ai_probability;
  const aiProbElement = document.getElementById("aiProb");
  if (aiProb !== undefined && aiProb !== null) {
    const percentage = (aiProb * 100).toFixed(2);
    // Use 'prediction' from data if it exists, otherwise calculate it
    const prediction = data.prediction || (aiProb > 0.5 ? "AI-generated" : "Real");
    aiProbElement.innerHTML = `
      <strong style="font-size: 1.4rem; color: #222;">${prediction}</strong><br>
      AI Probability: ${percentage}%<br>
      Real Probability: ${((1 - aiProb) * 100).toFixed(2)}%
    `;
  } else {
    aiProbElement.innerText = "AI detection not available";
  }
}

// ‚úÖ Grad-CAM generation function
async function generateGradCAM() {
  if (!data) {
    alert("No image found. Please analyze an image first.");
    return;
  }

  const button = document.getElementById("gradcamBtn");
  const loadingMsg = document.getElementById("loadingMsg");
  const resultDiv = document.getElementById("gradcamResult");
  
  // Disable button and show loading
  button.disabled = true;
  button.innerText = "Generating...";
  loadingMsg.style.display = "block";
  resultDiv.innerHTML = ""; // Clear previous results

  try {
    // Fetch the original image file
    const fileResponse = await fetch(`/uploads/${data.filename}`);
    
    if (!fileResponse.ok) {
      throw new Error("Failed to fetch image file");
    }
    
    const blob = await fileResponse.blob();
    
    // Create FormData with the file
    const formData = new FormData();
    const fileExtension = data.filename.split('.').pop().toLowerCase();
    const mimeTypes = {
      'jpg': 'image/jpeg',
      'jpeg': 'image/jpeg',
      'png': 'image/png',
      'gif': 'image/gif',
      'webp': 'image/webp'
    };
    const mimeType = mimeTypes[fileExtension] || 'image/jpeg';
    
    const file = new File([blob], data.filename, { type: mimeType });
    formData.append("file", file);

    console.log("Sending file:", data.filename, "Type:", mimeType);

    // Request Grad-CAM visualization
    const response = await fetch("/gradcam", {
      method: "POST",
      body: formData
    });

    console.log("Response status:", response.status);

    if (!response.ok) {
      let errorDetail = `Server error: ${response.status}`;
      try {
        const errorData = await response.json();
        console.error("Server error response:", errorData);
        errorDetail = JSON.stringify(errorData, null, 2);
      } catch (e) {
        const errorText = await response.text();
        console.error("Server error text:", errorText);
        errorDetail = errorText || errorDetail;
      }
      throw new Error(errorDetail);
    }

    const result = await response.json();
    console.log("Grad-CAM result:", result);

    // Display Grad-CAM image
    if (result.gradcam_image_url) {
      // Use the corrected variable name
      const imagePath = result.gradcam_image_url.startsWith('/') 
        ? result.gradcam_image_url.substring(1) 
        : result.gradcam_image_url;
      
      resultDiv.innerHTML = `
        <img src="/${imagePath}" 
             alt="Grad-CAM Visualization"
             style="width: 100%; height: auto; border-radius: 8px; margin-top: 1rem;"
             onerror="this.onerror=null; this.alt='Failed to load Grad-CAM image';">
        <p style="color: #666; font-size: 0.9rem; margin-top: 1rem;">
          Grad-CAM highlights the regions that influenced the AI detection model's decision.
        </p>
      `;
      button.innerText = "Regenerate Grad-CAM";
    } else {
      throw new Error("No Grad-CAM image path in response");
    }
    
  } catch (error) {
    console.error("Full error details:", error);
    
    let errorMessage = error.message;
    
    resultDiv.innerHTML = `
      <div class="error-box">
        <p>‚ùå Error generating Grad-CAM</p>
        <pre>${errorMessage}</pre>
        <p style="color: #666; font-size: 14px; margin-top: 10px;">
          Please check the browser console (F12) for full error details.
        </p>
      </div>
    `;
    button.innerText = "Retry Grad-CAM";
  } finally {
    button.disabled = false;
    loadingMsg.style.display = "none";
  }
}
</script>

</body>
</html>